# ========================================================================================== #
#                                                                                            #
#                             <<< Neural Network Results Plotter >>>                         #
#                                                                                            #
# ========================================================================================== #
#                                                                                            #
#  This script loads the results from a 'results.npz' file (generated by the batch          #
#  training script) and creates a scatter plot of final losses against the number of         #
#  activation regions. The plot is then saved as a PNG image.                                #
#                                                                                            #
# ========================================================================================== #


import numpy as np
import matplotlib.pyplot as plt
import os
import glob # For finding the latest results folder

def plot_experiment_results(results_folder=None):
    """
    Loads results from a specified folder (or the latest if none provided)
    and generates a scatter plot.
    """
    if results_folder is None:
        # Find the latest results folder if not specified
        list_of_folders = glob.glob('results/*')
        if not list_of_folders:
            print("Error: No 'results' folders found. Please run the training script first.")
            return
        results_folder = max(list_of_folders, key=os.path.getctime)
        print(f"Loading results from the latest folder: '{results_folder}'")
    else:
        if not os.path.isdir(results_folder):
            print(f"Error: Specified results folder '{results_folder}' does not exist.")
            return
        print(f"Loading results from specified folder: '{results_folder}'")

    results_file = os.path.join(results_folder, 'results.npz')

    if not os.path.exists(results_file):
        print(f"Error: 'results.npz' not found in '{results_folder}'.")
        return

    # Load the data
    data = np.load(results_file)
    final_losses = data['final_losses']
    activation_regions = data['activation_regions']

    if len(final_losses) == 0:
        print("No data found to plot. 'final_losses' array is empty.")
        return

    print(f"Loaded {len(final_losses)} data points.")
    print(f"Final Losses (min/max/avg): {np.min(final_losses):.4f} / {np.max(final_losses):.4f} / {np.mean(final_losses):.4f}")
    print(f"Activation Regions (min/max/avg): {np.min(activation_regions)} / {np.max(activation_regions)} / {np.mean(activation_regions):.2f}")

    # Create the scatter plot
    plt.figure(figsize=(10, 7))
    plt.scatter(final_losses, activation_regions, alpha=0.7, edgecolors='w', s=100)

    plt.title('Final Validation Loss vs. Number of Activation Regions', fontsize=16)
    plt.xlabel('Final Validation Loss (MSE)', fontsize=12)
    plt.ylabel('Number of Activation Regions', fontsize=12)
    plt.grid(True, linestyle='--', alpha=0.6)
    plt.axhline(y=1, color='gray', linestyle=':', linewidth=1, label='Min Regions (Linear)')
    plt.legend()

    # Save the plot
    plot_filename = os.path.join(results_folder, 'loss_vs_regions_scatter.png')
    plt.savefig(plot_filename)
    plt.close() # Close the plot to free memory
    print(f"âœ“ Scatter plot saved to '{plot_filename}'.")

if __name__ == '__main__':
    # You can specify a results folder directly, e.g., plot_experiment_results('results/2023-10-27_10-30-00')
    # If no argument is given, it will automatically find the latest created results folder.
    plot_experiment_results()